---
title: "mumps"
author: "Jessica Leviton"
date: "4/6/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r import}
library(tidyverse)

read_csv("mumps.csv") %>%
  select(week, state, state_name, cases) -> mumps

mumps$Year <- substr(mumps$week, 1, 4)
mumps$weeknum <- substr(mumps$week, 5, 6)
mumps$time <- as.numeric(mumps$Year) + as.numeric(mumps$weeknum)/52

head(mumps)

#mumps_MI <- mumps[mumps$state == 'MI',]
#mumps_MI <- subset(mumps, (state == 'MI'))
#mumps_data <- subset(mumps_MI, (week > 197037) & (week < 197236), #select=c("time", "reports"))

mumps_data = mumps %>%
  filter(state_name == "MICHIGAN") %>%
  filter(week >= 197037 & week <= 197236) %>%
  select(cases) %>%
  mutate(week = 1:100) %>%
  relocate(week, cases)

head(mumps_data)
# mumps_data_t0 <- mumps_data$time[1]
mumps_data_t0 <- 0


plot(mumps_data$cases~mumps_data$week, type='l')
```

Chapter 14 Notes:

```{r pomp, cache=FALSE}
library(pomp)

seir_step <- Csnippet("
double dN_SE = rbinom(S, 1-exp(-Beta*I/N*dt));
double dN_EI = rbinom(E, 1-exp(-mu_EI*dt));
double dN_IR = rbinom(I, 1-exp(-mu_IR*dt));
S -= dN_SE;
E += dN_SE - dN_EI;
I += dN_EI - dN_IR;
H += dN_IR;
")

seir_init <- Csnippet("
S = nearbyint(eta*N);
E = 0;
I = 1;
H = 0;
")

dmeas <- Csnippet("
lik = dbinom(cases, H, rho, give_log);
")

rmeas <- Csnippet("
cases = rbinom(H, rho);
")

mumps_data %>%
  pomp(
    times="week", t0=0,
    rprocess=euler(seir_step, delta.t=1/7),
    rinit=seir_init,
    rmeasure=rmeas,
    dmeasure=dmeas,
    accumvars="H",
    partrans=parameter_trans(
      log=c("Beta", "mu_EI"),
      logit=c("rho", "eta")
    ),
    statenames=c("S", "E", "I", "H"),
    paramnames=c("Beta", "mu_EI", "mu_IR", "eta", "rho", "N")
  ) -> mumpSIR

mumps_fixed_params <- c(N=9000000, mu_EI=3.5, mu_IR=1)
params <- c(Beta=60, rho=0.5, eta=0.0416, mumps_fixed_params)

# params <- c(Beta=20, mu_EI=3.5, mu_IR=2, rho=0.5, eta=0.1, N=38000)
# fixed_params <- c(N=38000, mu_IR=2)

```

Now, we'll do the actual fitting

```{r local, cache=FALSE}
run_level <- 2
mumps_Np <- switch(run_level, 100, 1e3, 5e3)
mumps_Nmif <- switch(run_level, 10, 100, 200)
mumps_Nreps_eval <- switch(run_level, 2, 10, 20)
mumps_Nreps_local <- switch(run_level, 10, 20, 40)
mumps_Nreps_global <- switch(run_level, 10, 20, 100)
mumps_Nsim <- switch(run_level, 50, 100, 500)

library(foreach)
library(doParallel)
registerDoParallel()
library(doRNG)
registerDoRNG(3899882)

#Testing work:
mumpSIR %>%
  pfilter(Np=mumps_Np, params=params) -> pf

logLik(pf)
plot(pf)

mumpSIR %>%
  simulate(params=params, nsim=10, format="data.frame", include.data=TRUE) -> y


y %>%
  ggplot(aes(x=week, y=cases, group=.id, color=factor(.id)))+
  geom_line()+
 # ylim(0,100)+
  scale_color_brewer(type="qual", palette=3)+
  guides(color=FALSE)


foreach(i=1:mumps_Nreps_local,.combine=c) %dopar% { 
  library(pomp)
  library(tidyverse)
  mumpSIR %>%
    mif2(
      params=params,
      Np=mumps_Np, Nmif=mumps_Nmif,
      cooling.fraction.50=0.5,
      rw.sd=rw.sd(Beta=0.02, rho=0.02, eta=ivp(0.02))
    )
} -> mifs_local

lik_local <- foreach(i=1:mumps_Nreps_local, .combine=rbind) %dopar% {
  library(pomp)
  library(tidyverse)
  logmeanexp(
    replicate(mumps_Nreps_eval,
      logLik(pfilter(mumpSIR,
        params=coef(mifs_local[[i]]), Np=mumps_Np))),
    se=TRUE)
}

lik_local
r_local <- data.frame(logLik=lik_local[,1], logLik_se=lik_local[,2],
                      t(sapply(mifs_local, coef)))

summary(r_local$logLik, digits=5)

# mifs_local %>% logLik() %>% logmeanexp(se=TRUE) -> L_pf
# L_pf

mifs_local %>%
  traces() %>%
  melt() %>%
  ggplot(aes(x=iteration,y=value,group=L1,color=factor(L1)))+
  geom_line()+
  guides(color=FALSE)+
  facet_wrap(~variable,scales="free_y")

```


```{r global, cache=FALSE}


mumps_box <- rbind(
  Beta=c(5,5e6), eta=c(0,0.60), rho=c(0, 0.9)
)

mifs_global <- foreach(i=1:mumps_Nreps_global, .packages='pomp', 
  .combine=c) %dopar% mif2(mifs_local[[1]],
    params=c(apply(mumps_box, 1, function(x)runif(1,x[1],x[2])),
    mumps_fixed_params)
  )

lik_global <- foreach(i=1:mumps_Nreps_global, .packages='pomp',
  .combine=rbind) %dopar% logmeanexp(
    replicate(mumps_Nreps_eval,
      logLik(pfilter(mumpSIR,
        params=coef(mifs_global[[i]]), Np=mumps_Np))),
    se=TRUE)

r_global <- data.frame(logLik=lik_global[,1], logLik_se=lik_global[,2],
                       t(sapply(mifs_global, coef)))

summary(r_global$logLik, digits=5)
```

Alright, cool. It looks like the "week" data is formated "YYYY##" where ## is the "number" of the week, ranging from 01 to 52.


This link could have some useful general information, but you should also check CDC and other sites for mumps info: https://www.cdc.gov/mmwr/preview/mmwrhtml/mm5513a3.htm


https://www.senate.michigan.gov/sfa/Economics/Michigan&USPopulation.PDF
According to michigan.gov, the population of Michigan only increased by about 2% from the year 1970 to the year 1974. I would argue that that's a small enough change that we can approximate the demographics as constant.

vaccination rate info: https://www.statista.com/statistics/385577/mmr-vaccination-rate-among-us-children-aged-19-35-months/

better vaccination rate info: https://www.cdc.gov/vaccines/pubs/pinkbook/downloads/appendices/g/coverage.pdf

